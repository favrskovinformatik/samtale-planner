<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>

  <body>
    <div id="root"></div>

    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide")

# ---------------- STYLE ----------------
st.markdown("""
<style>
[data-testid="stSidebar"] { min-width: 450px !important; }
</style>
""", unsafe_allow_html=True)

st.title("üóìÔ∏è Samtaleplanl√¶gger")

# ---------------- SIDEBAR ----------------
st.sidebar.header("Indstillinger")
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", "17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)

# ---------------- HJ√ÜLP ----------------
def evaluer_plan(df):
    elev_wait, l√¶rer_wait = [], []

    for e in df['Elevid'].unique():
        p = df[df['Elevid'] == e].sort_values('Start_dt')
        for i in range(len(p)-1):
            elev_wait.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds()/60)

    for l in df['L√¶rer'].unique():
        p = df[df['L√¶rer'] == l].sort_values('Start_dt')
        for i in range(len(p)-1):
            l√¶rer_wait.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds()/60)

    return max(elev_wait) if elev_wait else 0, sum(l√¶rer_wait)/len(l√¶rer_wait) if l√¶rer_wait else 0

# ---------------- KERNEALGORITME (UDGAVE 2) ----------------
def lav_plan(df_opg, start_dt, l√¶rer_r√¶kkef√∏lge):
    l√¶rer_fri = {l: start_dt for l in df_opg['L√¶rer'].unique()}
    elev_fri = {e: start_dt for e in df_opg['Elevid'].unique()}
    rester = df_opg.copy()
    plan = []

    for l√¶r in l√¶rer_r√¶kkef√∏lge:
        while True:
            mine = rester[rester['L√¶rer'] == l√¶r]
            if mine.empty:
                break

            bedste, bedste_start = None, datetime.max

            for idx, r in mine.iterrows():
                st = max(l√¶rer_fri[l√¶r], elev_fri[r['Elevid']])
                vent = (st - elev_fri[r['Elevid']]).total_seconds()/60
                if vent <= 20 and st < bedste_start:
                    bedste, bedste_start = idx, st

            if bedste is None:
                for idx, r in mine.iterrows():
                    st = max(l√¶rer_fri[l√¶r], elev_fri[r['Elevid']])
                    if st < bedste_start:
                        bedste, bedste_start = idx, st

            r = mine.loc[bedste]
            sl = bedste_start + timedelta(minutes=varighed)

            plan.append({**r, "Start_dt": bedste_start, "Slut_dt": sl})
            l√¶rer_fri[l√¶r] = sl
            elev_fri[r['Elevid']] = sl
            rester = rester.drop(bedste)

    return pd.DataFrame(plan)

# ---------------- STRATEGI-S√òGNING ----------------
def beregn_bedste(df):
    start_dt = datetime.strptime(start_tid_input.replace(".", ":"), "%H:%M")

    df['Elevid'] = df['Elevid'].astype(str)
    df['Klasse'] = df['Elevid'].str[:2]

    opg = []
    for _, r in df.iterrows():
        for o in str(r['√ònsker']).split(","):
            opg.append({
                "Elevnavn": r['Elevnavn'],
                "Elevid": r['Elevid'],
                "Klasse": r['Klasse'],
                "L√¶rer": o.strip().split()[0]
            })
    df_opg = pd.DataFrame(opg)

    strategier = [
        ("L√¶rer-belastning", sorted(df_opg['L√¶rer'].unique(), key=lambda x: -len(df_opg[df_opg['L√¶rer']==x]))),
        ("Klasse-sammenhold", df_opg.sort_values("Klasse")['L√¶rer'].unique()),
        ("Alfabetisk", sorted(df_opg['L√¶rer'].unique()))
    ]

    bedste, bedste_score = None, 1e9
    tests = []

    for navn, r√¶kkef√∏lge in strategier:
        plan = lav_plan(df_opg, start_dt, r√¶kkef√∏lge)
        max_e, avg_l = evaluer_plan(plan)

        tests.append({
            "Strategi": navn,
            "Max elevventetid": round(max_e,1),
            "Gns. l√¶rerventetid": round(avg_l,1)
        })

        if max_e <= 20 and avg_l < bedste_score:
            bedste, bedste_score = plan.copy(), avg_l

    return bedste, pd.DataFrame(tests)

# ---------------- EXCEL-GENERERING (UDGAVE 1 + 2) ----------------
def generer_excel(plan, tests):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:

        elevark = plan.sort_values(["Elevid","Start_dt"])[
            ["Elevnavn","Elevid","Klasse","L√¶rer","Start_dt","Slut_dt"]
        ]
        elevark.to_excel(writer, sheet_name="Elevoversigt", index=False)

        l√¶rerark = plan.sort_values(["L√¶rer","Start_dt"])[
            ["L√¶rer","Elevnavn","Elevid","Klasse","Start_dt","Slut_dt"]
        ]
        l√¶rerark.to_excel(writer, sheet_name="L√¶reroversigt", index=False)

        plan.to_excel(writer, sheet_name="Samlet plan (r√•)", index=False)
        tests.to_excel(writer, sheet_name="Test-oversigt", index=False)

    return output.getvalue()

# ---------------- APP FLOW ----------------
uploaded = st.file_uploader("Upload Excel-fil", type=["xlsx"])
if uploaded:
    df = pd.read_excel(uploaded)
    plan, tests = beregn_bedste(df)

    if plan is None:
        st.error("Ingen plan opfyldte kravet om max 20 minutters elevventetid.")
    else:
        st.success("Plan genereret korrekt")

        excel_bytes = generer_excel(plan, tests)
        st.download_button(
            "üì• Hent Excel med faner",
            data=excel_bytes,
            file_name="Samtaleplan.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )

        st.markdown("### Test-oversigt")
        st.dataframe(tests)
`
        }
      });
    </script>
  </body>
</html>
