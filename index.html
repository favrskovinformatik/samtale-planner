<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io
import itertools

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide", page_icon="üóìÔ∏è")

# --- UI STYLING (IDENTISK MED UDGAVE 1) ---
st.markdown("""
<style>
    [data-testid="stSidebar"] { min-width: 450px !important; }
    .stTextInput label, .stTextArea label, .stNumberInput label { font-weight: bold; }
    .example-table { margin-bottom: 20px; border-collapse: collapse; width: 100%; }
    .example-table td, .example-table th { border: 1px solid #ddd; padding: 8px; font-size: 0.9em; }
    .example-table th { background-color: #f2f2f2; text-align: left; }
</style>
""", unsafe_allow_html=True)

st.title("üóìÔ∏è Samtaleplanl√¶gger")

# --- INSTRUKTION OG EKSEMPEL ---
st.info("### 1. Forbered din Excel-fil")
st.markdown("""
S√∏rg for at dit regneark har pr√¶cis disse tre kolonneoverskrifter. Her er et eksempel p√•, hvordan en r√¶kke skal se ud:
""")

example_data = {
    "Elevnavn": ["Jonas Petersen"],
    "Elevid": ["1x 07"],
    "√ònsker": ["AG samfundsfag, SR, FH biologi, FH idr√¶t, GU"]
}
st.table(pd.DataFrame(example_data))

st.markdown("""
Regnearket kan godt have flere kolonner, men de bliver ignoreret. Det samme g√¶lder fagene - det er kun initialerne, som programmet bruger.
""")

# --- SIDEBAR ---
st.sidebar.header("1. Indstillinger")
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)

st.sidebar.markdown("---")
st.sidebar.header("2. Lokaler & Logistik")
lokale_buffer = st.sidebar.number_input("Pause ved l√¶rerskift i lokale (min)", value=10, step=5)
default_lokaler = "101, 409, 308, 309, 310, 312, 313, 315, 317, 508, 509, 510, 511, 513, 320, 321, 322, 323, 324, 210, 211, 213, 215, 216, 217, 218, 219, 220, M√∏de 1, M√∏de 2, M√∏de 3, M√∏de 4, M√∏de 5"
lokale_str = st.sidebar.text_area("Lokaler (komma-separeret)", value=default_lokaler)

st.sidebar.markdown("---")
st.sidebar.header("3. Specifikke √∏nsker")
specifikke_tider_raw = st.sidebar.text_area(
    "Vejledninger for specifikke l√¶rere og elever planl√¶gges fra dette tidspunkt (Format: ID=tt.mm)",
    placeholder="AB=17.30\\n1q 18=17.00"
)

# -------------------------------------------------
# HJ√ÜLPEFUNKTIONER
# -------------------------------------------------

def parse_tider(text):
    out = {}
    if not text:
        return out
    for line in text.split("\\n"):
        if "=" in line:
            k, v = line.split("=")
            out[k.strip()] = datetime.strptime(v.strip().replace(".", ":"), "%H:%M")
    return out

def evaluer_plan(df):
    elev_waits = []
    l√¶rer_pauser = []

    for e in df['Elevid'].unique():
        p = df[df['Elevid'] == e].sort_values('Start_dt')
        for i in range(len(p) - 1):
            elev_waits.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds() / 60)

    for l in df['L√¶rer'].unique():
        p = df[df['L√¶rer'] == l].sort_values('Start_dt')
        for i in range(len(p) - 1):
            l√¶rer_pauser.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds() / 60)

    max_elev = max(elev_waits) if elev_waits else 0
    avg_l√¶rer = sum(l√¶rer_pauser) / len(l√¶rer_pauser) if l√¶rer_pauser else 0

    return max_elev, avg_l√¶rer

# -------------------------------------------------
# PLANVARIANT
# -------------------------------------------------

def lav_plan(df_opg, start_dt, l√¶rer_sort):
    l√¶rer_fri = {l: start_dt for l in df_opg['L√¶rer'].unique()}
    elev_fri = {e: start_dt for e in df_opg['Elevid'].unique()}
    rester = df_opg.copy()
    plan = []

    for l√¶r in l√¶rer_sort(df_opg):
        mine = rester[rester['L√¶rer'] == l√¶r]
        for idx, row in mine.iterrows():
            e = row['Elevid']
            st = max(l√¶rer_fri[l√¶r], elev_fri[e])
            sl = st + timedelta(minutes=varighed)

            plan.append({**row, 'Start_dt': st, 'Slut_dt': sl})
            l√¶rer_fri[l√¶r] = sl
            elev_fri[e] = sl
            rester = rester.drop(idx)

    return pd.DataFrame(plan)

# -------------------------------------------------
# HOVEDALGORITME (BRUTE FORCE HEURISTIK)
# -------------------------------------------------

def beregn_bedste_plan(df):
    start_dt = datetime.strptime(start_tid_input.replace(".", ":"), "%H:%M")

    df = df.dropna(subset=['Elevnavn', 'Elevid', '√ònsker'])
    df['Elevid'] = df['Elevid'].astype(str).str.strip()
    df['Klasse'] = df['Elevid'].str[:2]

    opgaver = []
    for _, r in df.iterrows():
        for o in str(r['√ònsker']).split(","):
            opgaver.append({
                'Elevnavn': r['Elevnavn'],
                'Elevid': r['Elevid'],
                'Klasse': r['Klasse'],
                'L√¶rer': o.strip().split()[0]
            })

    df_opg = pd.DataFrame(opgaver)

    strategier = [
        ("L√¶rer-belastning", lambda d: sorted(d['L√¶rer'].unique(), key=lambda x: -len(d[d['L√¶rer'] == x]))),
        ("Klasse-f√∏rst", lambda d: d.sort_values('Klasse')['L√¶rer'].unique()),
        ("Alfabetisk", lambda d: sorted(d['L√¶rer'].unique()))
    ]

    tests = []
    bedste = None
    bedste_score = float("inf")

    for navn, sort_l√¶rer in strategier:
        plan = lav_plan(df_opg, start_dt, sort_l√¶rer)
        max_elev, avg_l√¶rer = evaluer_plan(plan)

        tests.append({
            "Strategi": navn,
            "Max elevventetid": round(max_elev, 1),
            "Gns. l√¶rerventetid": round(avg_l√¶rer, 1)
        })

        if max_elev <= 20 and avg_l√¶rer < bedste_score:
            bedste_score = avg_l√¶rer
            bedste = plan.copy()

    return bedste, pd.DataFrame(tests)

# -------------------------------------------------
# APP FLOW
# -------------------------------------------------

uploaded_file = st.file_uploader("Upload Excel med de korrekte kolonner", type=["xlsx"])
if uploaded_file:
    df_in = pd.read_excel(uploaded_file)

    if not all(col in df_in.columns for col in ['Elevnavn', 'Elevid', '√ònsker']):
        st.error("Excel-filen skal indeholde kolonnerne: Elevnavn, Elevid, √ònsker")
    else:
        plan, tests = beregn_bedste_plan(df_in)

        if plan is None:
            st.error("Ingen plan opfyldte kravet om max 20 minutters elevventetid.")
        else:
            plan['Start'] = plan['Start_dt'].dt.strftime("%H:%M")
            sidste = plan.sort_values('Slut_dt').iloc[-1]

            st.success(f"F√¶rdig! Sidste samtale kl. {sidste['Slut_dt'].strftime('%H:%M')}")

            st.markdown("### üî¨ Test-oversigt (afpr√∏vede strategier)")
            st.dataframe(tests.sort_values("Gns. l√¶rerventetid"))

            st.markdown("### Download resultater")
            c1, c2 = st.columns(2)
            c1.download_button("üì• Hent Elevoversigt", data=plan.to_csv(index=False), file_name="Elevoversigt.csv")
            c2.download_button("üì• Hent L√¶reroversigt", data=plan.to_csv(index=False), file_name="Laereroversigt.csv")
`
        },
      });
    </script>
  </body>
</html>
