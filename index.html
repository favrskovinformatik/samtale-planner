<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>SamtaleplanlÃ¦gger Pro</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="SamtaleplanlÃ¦gger", layout="wide", page_icon="ğŸ—“ï¸")

st.markdown("""
<style>
    [data-testid="stSidebar"] { min-width: 450px !important; }
    .stTextInput label, .stTextArea label, .stNumberInput label { 
        white-space: nowrap !important; 
        font-weight: bold; 
    }
</style>
""", unsafe_allow_html=True)

st.title("ğŸ—“ï¸ SamtaleplanlÃ¦gger")

# --- SIDEBAR ---
st.sidebar.header("1. Indstillinger")
# Ã†ndring 1: Default starttidspunkt sat til 17.00
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)

st.sidebar.markdown("---")
st.sidebar.header("2. Lokaler & Logistik")
lokale_buffer = st.sidebar.number_input("Pause ved lÃ¦rerskift i lokale (min)", value=10, step=5)

# Ã†ndring 2: Ny default lokaleliste (inkl. tekst-baserede lokaler)
default_lokaler = "101, 409, 308, 309, 310, 312, 313, 315, 317, 508, 509, 510, 511, 513, 320, 321, 322, 323, 324, 210, 211, 213, 215, 216, 217, 218, 219, 220, MÃ¸de 1, MÃ¸de 2, MÃ¸de 3, MÃ¸de 4, MÃ¸de 5"
lokale_str = st.sidebar.text_area("Lokaler (komma-separeret)", value=default_lokaler)

st.sidebar.markdown("---")
st.sidebar.header("3. Specifikke Ã¸nsker")
specifikke_tider_raw = st.sidebar.text_area("LÃ¥ste tider (Format: ID=tt.mm)", placeholder="AB=17.30\\n1q 18=17.00")

# --- LOGIK ---

def parse_tider(text_input):
    lÃ¥ste_tider = {}
    if not text_input: return lÃ¥ste_tider
    for line in text_input.split('\\n'):
        if '=' in line:
            parts = line.split('=')
            key = parts[0].strip()
            time_val = parts[1].strip().replace('.', ':')
            lÃ¥ste_tider[key] = time_val
    return lÃ¥ste_tider

def beregn_plan(df, start_str, lokaler_raw, spec_tider_dict, varighed_min, buffer_min):
    try:
        start_dt = datetime.strptime(start_str.replace('.', ':'), "%H:%M")
        df['Elevid'] = df['Elevid'].astype(str).str.strip()
        df['Klasse'] = df['Elevid'].str[:2]
        
        samtaler = []
        lÃ¦rer_klasser = {} 
        
        for idx, row in df.iterrows():
            rÃ¥_Ã¸nsker = [x.strip() for x in str(row['Ã˜nsker']).split(',') if x.strip()]
            for item in rÃ¥_Ã¸nsker:
                dele = item.split()
                if not dele: continue
                lÃ¦r = dele[0]
                samtaler.append({
                    'Elevnavn': row['Elevnavn'],
                    'Elevid': row['Elevid'],
                    'LÃ¦rer': lÃ¦r,
                    'Klasse': row['Klasse']
                })
                if lÃ¦r not in lÃ¦rer_klasser: lÃ¦rer_klasser[lÃ¦r] = []
                lÃ¦rer_klasser[lÃ¦r].append(row['Klasse'])
        
        df_samtaler = pd.DataFrame(samtaler)
        if df_samtaler.empty: return "Ingen gyldige Ã¸nsker fundet."

        alle_lÃ¦rere = df_samtaler['LÃ¦rer'].unique()
        alle_elever = df_samtaler['Elevid'].unique()
        primÃ¦r_klasse = {l: max(set(k), key=k.count) for l, k in lÃ¦rer_klasser.items()}

        lÃ¦rer_fri = {l: start_dt for l in alle_lÃ¦rere}
        elev_fri = {e: start_dt for e in alle_elever}
        
        for id_key, tid_str in spec_tider_dict.items():
            try:
                spec_dt = datetime.strptime(tid_str, "%H:%M")
                if id_key in lÃ¦rer_fri: lÃ¦rer_fri[id_key] = spec_dt
                if id_key in elev_fri: elev_fri[id_key] = spec_dt
            except: pass

        fÃ¦rdig_plan = []
        for elev_id in alle_elever:
            mine_samtaler = df_samtaler[df_samtaler['Elevid'] == elev_id]
            for _, r in mine_samtaler.iterrows():
                lÃ¦r = r['LÃ¦rer']
                start = max(lÃ¦rer_fri[lÃ¦r], elev_fri[elev_id])
                slut = start + timedelta(minutes=varighed_min)
                fÃ¦rdig_plan.append({
                    'Elevnavn': r['Elevnavn'], 'Elevid': elev_id, 'Klasse': r['Klasse'],
                    'LÃ¦rer': lÃ¦r, 'Start_dt': start, 'Slut_dt': slut
                })
                lÃ¦rer_fri[lÃ¦r] = slut
                elev_fri[elev_id] = slut

        res_df = pd.DataFrame(fÃ¦rdig_plan)

        # Ã†ndring 2: Sortering der hÃ¥ndterer bÃ¥de tal og tekst (MÃ¸de 1 osv)
        lokaler = [l.strip() for l in lokaler_raw.split(',') if l.strip()]
        
        lÃ¦rer_blokke = res_df.groupby('LÃ¦rer').agg(Min_Start=('Start_dt', 'min'), Max_Slut=('Slut_dt', 'max')).reset_index()
        lÃ¦rer_blokke['PrimÃ¦r_Klasse'] = lÃ¦rer_blokke['LÃ¦rer'].map(primÃ¦r_klasse)
        lÃ¦rer_blokke = lÃ¦rer_blokke.sort_values(['PrimÃ¦r_Klasse', 'Min_Start'])
        
        lokale_ledig_fra = {lok: start_dt - timedelta(minutes=buffer_min) for lok in lokaler}
        lÃ¦rer_til_lokale = {}
        
        for _, row in lÃ¦rer_blokke.iterrows():
            lÃ¦r = row['LÃ¦rer']
            s_blok = row['Min_Start']
            valgt = None
            for lok in lokaler:
                if s_blok >= lokale_ledig_fra[lok] + timedelta(minutes=buffer_min):
                    valgt = lok
                    lokale_ledig_fra[lok] = row['Max_Slut']
                    break
            # Ã†ndring 4: MarkÃ¸r for manglende lokale
            lÃ¦rer_til_lokale[lÃ¦r] = valgt if valgt else "âš ï¸ MANGLER LOKALE"

        res_df['Lokale'] = res_df['LÃ¦rer'].map(lÃ¦rer_til_lokale)
        res_df['Start'] = res_df['Start_dt'].dt.strftime("%H:%M")
        
        return res_df

    except Exception as e:
        return str(e)

# --- EXCEL GENERERING ---

def prep_pivot(df_sub, index_col, col_cols, value_col):
    pivot = df_sub.pivot_table(index=index_col, columns=col_cols, values=value_col, aggfunc='first').fillna("")
    if isinstance(pivot.columns, pd.MultiIndex):
        pivot.columns = [f"{l} ({loc})" for l, loc in pivot.columns]
    return pivot

def generate_excel_elev(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        for klasse in sorted(df['Klasse'].unique()):
            df_k = df[df['Klasse'] == klasse]
            pivot = prep_pivot(df_k, 'Elevnavn', ['LÃ¦rer', 'Lokale'], 'Start')
            pivot.to_excel(writer, sheet_name=f'Klasse {klasse}')
    return output.getvalue()

def generate_excel_laerer(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        for klasse in sorted(df['Klasse'].unique()):
            df_k = df[df['Klasse'] == klasse]
            pivot = prep_pivot(df_k, 'Start', ['LÃ¦rer', 'Lokale'], 'Elevid')
            pivot.to_excel(writer, sheet_name=f'Klasse {klasse}')
    return output.getvalue()

# --- UI ---
st.info("Krav: Kolonner 'Elevnavn', 'Elevid', 'Ã˜nsker'.")

uploaded_file = st.file_uploader("Upload Excel", type=["xlsx"])

if uploaded_file:
    df_in = pd.read_excel(uploaded_file)
    if all(col in df_in.columns for col in ['Elevnavn', 'Elevid', 'Ã˜nsker']):
        res = beregn_plan(df_in, start_tid_input, lokale_str, parse_tider(specifikke_tider_raw), varighed, lokale_buffer)
        
        if isinstance(res, str):
            st.error(f"Fejl: {res}")
        else:
            # Ã†ndring 4: Tjek for manglende lokaler og vis det pÃ¥ forsiden
            mangler_lokaler = res[res['Lokale'] == "âš ï¸ MANGLER LOKALE"]['LÃ¦rer'].unique()
            if len(mangler_lokaler) > 0:
                st.error(f"âš ï¸ MANGEL PÃ… LOKALER: FÃ¸lgende lÃ¦rere kunne ikke tildeles et lokale pga. buffer-kravet: {', '.join(mangler_lokaler)}")
                st.warning("Overvej at tilfÃ¸je flere lokaler eller reducere buffer-tiden.")
            else:
                st.success("Plan genereret uden fejl!")
            
            # Ã†ndring 3: Kun download-knapper, ingen forhÃ¥ndsvisning
            st.subheader("Hent planer")
            col1, col2 = st.columns(2)
            with col1:
                st.download_button("ğŸ“¥ Hent Elevoversigt (pr. klasse)", data=generate_excel_elev(res), file_name="Elevoversigt_pr_klasse.xlsx")
            with col2:
                st.download_button("ğŸ“¥ Hent LÃ¦reroversigt (pr. klasse)", data=generate_excel_laerer(res), file_name="Laereroversigt_pr_klasse.xlsx")
    else:
        st.error("Manglende kolonner i Excel.")
`
        },
      });
    </script>
  </body>
</html>
