<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide", page_icon="üóìÔ∏è")

# ---------------- UI (IDENTISK MED UDGAVE 1) ----------------
st.markdown("""
<style>
[data-testid="stSidebar"] { min-width: 450px !important; }
.stTextInput label, .stTextArea label, .stNumberInput label { font-weight: bold; }
.example-table { margin-bottom: 20px; border-collapse: collapse; width: 100%; }
.example-table td, .example-table th { border: 1px solid #ddd; padding: 8px; font-size: 0.9em; }
.example-table th { background-color: #f2f2f2; text-align: left; }
</style>
""", unsafe_allow_html=True)

st.title("üóìÔ∏è Samtaleplanl√¶gger")

st.info("### 1. Forbered din Excel-fil")
st.markdown("S√∏rg for at dit regneark har pr√¶cis disse tre kolonneoverskrifter.")

example_data = {
    "Elevnavn": ["Jonas Petersen"],
    "Elevid": ["1x 07"],
    "√ònsker": ["AG samfundsfag, SR, FH biologi, FH idr√¶t, GU"]
}
st.table(pd.DataFrame(example_data))

# ---------------- SIDEBAR ----------------
st.sidebar.header("1. Indstillinger")
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)

st.sidebar.markdown("---")
st.sidebar.header("2. Lokaler & Logistik")
lokale_buffer = st.sidebar.number_input("Pause ved l√¶rerskift i lokale (min)", value=10, step=5)
lokale_str = st.sidebar.text_area(
    "Lokaler (komma-separeret)",
    value="101, 409, 308, 309, 310, 312, 313, 315, 317"
)

st.sidebar.markdown("---")
st.sidebar.header("3. Specifikke √∏nsker")
specifikke_tider_raw = st.sidebar.text_area(
    "Vejledninger for specifikke l√¶rere og elever planl√¶gges fra dette tidspunkt (Format: ID=tt.mm)"
)

# ---------------- HJ√ÜLP ----------------

def parse_tider(text):
    out = {}
    if not text:
        return out
    for l in text.split("\\n"):
        if "=" in l:
            k, v = l.split("=")
            out[k.strip()] = datetime.strptime(v.strip().replace(".", ":"), "%H:%M")
    return out

def evaluer_plan(df):
    elev_wait = []
    l√¶rer_wait = []

    for e in df['Elevid'].unique():
        p = df[df['Elevid'] == e].sort_values('Start_dt')
        for i in range(len(p)-1):
            elev_wait.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds()/60)

    for l in df['L√¶rer'].unique():
        p = df[df['L√¶rer'] == l].sort_values('Start_dt')
        for i in range(len(p)-1):
            l√¶rer_wait.append((p.iloc[i+1]['Start_dt'] - p.iloc[i]['Slut_dt']).total_seconds()/60)

    return max(elev_wait) if elev_wait else 0, sum(l√¶rer_wait)/len(l√¶rer_wait) if l√¶rer_wait else 0

# ---------------- KERNEALGORITME (FRA UDGAVE 2) ----------------

def lav_plan(df_opg, start_dt, l√¶rer_r√¶kkef√∏lge):
    l√¶rer_fri = {l: start_dt for l in df_opg['L√¶rer'].unique()}
    elev_fri = {e: start_dt for e in df_opg['Elevid'].unique()}
    rester = df_opg.copy()
    plan = []

    for l√¶r in l√¶rer_r√¶kkef√∏lge:
        while True:
            mine = rester[rester['L√¶rer'] == l√¶r]
            if mine.empty:
                break

            bedste = None
            bedste_start = datetime.max

            # SIKRING: <=20 min ventetid
            for idx, r in mine.iterrows():
                st = max(l√¶rer_fri[l√¶r], elev_fri[r['Elevid']])
                vent = (st - elev_fri[r['Elevid']]).total_seconds()/60
                if vent <= 20 and st < bedste_start:
                    bedste_start = st
                    bedste = idx

            # fallback
            if bedste is None:
                for idx, r in mine.iterrows():
                    st = max(l√¶rer_fri[l√¶r], elev_fri[r['Elevid']])
                    if st < bedste_start:
                        bedste_start = st
                        bedste = idx

            r = mine.loc[bedste]
            sl = bedste_start + timedelta(minutes=varighed)

            plan.append({**r, 'Start_dt': bedste_start, 'Slut_dt': sl})
            l√¶rer_fri[l√¶r] = sl
            elev_fri[r['Elevid']] = sl
            rester = rester.drop(bedste)

    return pd.DataFrame(plan)

# ---------------- BRUTE FORCE HEURISTIK ----------------

def beregn_bedste(df):
    start_dt = datetime.strptime(start_tid_input.replace(".", ":"), "%H:%M")

    df = df.dropna(subset=['Elevnavn','Elevid','√ònsker'])
    df['Elevid'] = df['Elevid'].astype(str)
    df['Klasse'] = df['Elevid'].str[:2]

    opg = []
    for _, r in df.iterrows():
        for o in str(r['√ònsker']).split(","):
            opg.append({
                'Elevnavn': r['Elevnavn'],
                'Elevid': r['Elevid'],
                'Klasse': r['Klasse'],
                'L√¶rer': o.strip().split()[0]
            })
    df_opg = pd.DataFrame(opg)

    strategier = [
        ("L√¶rer-belastning", sorted(df_opg['L√¶rer'].unique(), key=lambda x: -len(df_opg[df_opg['L√¶rer']==x]))),
        ("Klasse-sammenhold", df_opg.sort_values('Klasse')['L√¶rer'].unique()),
        ("Alfabetisk", sorted(df_opg['L√¶rer'].unique()))
    ]

    tests = []
    bedste = None
    bedste_score = 1e9

    for navn, r√¶kkef√∏lge in strategier:
        plan = lav_plan(df_opg, start_dt, r√¶kkef√∏lge)
        max_e, avg_l = evaluer_plan(plan)

        tests.append({
            "Strategi": navn,
            "Max elevventetid": round(max_e,1),
            "Gns. l√¶rerventetid": round(avg_l,1)
        })

        if max_e <= 20 and avg_l < bedste_score:
            bedste_score = avg_l
            bedste = plan.copy()

    return bedste, pd.DataFrame(tests)

# ---------------- APP FLOW ----------------

uploaded = st.file_uploader("Upload Excel med de korrekte kolonner", type=["xlsx"])
if uploaded:
    df = pd.read_excel(uploaded)
    plan, tests = beregn_bedste(df)

    if plan is None:
        st.error("Ingen plan opfyldte kravet om max 20 minutters elevventetid.")
    else:
        plan['Start'] = plan['Start_dt'].dt.strftime("%H:%M")
        sidste = plan.sort_values('Slut_dt').iloc[-1]
        st.success(f"F√¶rdig! Sidste samtale kl. {sidste['Slut_dt'].strftime('%H:%M')}")

        st.markdown("### üî¨ Test-oversigt")
        st.dataframe(tests)

        st.markdown("### Download resultater")
        c1, c2 = st.columns(2)
        c1.download_button("üì• Hent Elevoversigt", data=plan.to_csv(index=False), file_name="Elevoversigt.csv")
        c2.download_button("üì• Hent L√¶reroversigt", data=plan.to_csv(index=False), file_name="Laereroversigt.csv")
`
        }
      });
    </script>
  </body>
</html>
