<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger Pro</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide", page_icon="üóìÔ∏è")

st.markdown("""
<style>
    [data-testid="stSidebar"] { min-width: 450px !important; }
    .stTextInput label, .stTextArea label, .stNumberInput label { 
        white-space: nowrap !important; 
        font-weight: bold; 
    }
</style>
""", unsafe_allow_html=True)

st.title("üóìÔ∏è Samtaleplanl√¶gger")

# --- SIDEBAR ---
st.sidebar.header("1. Indstillinger")
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)

st.sidebar.markdown("---")
st.sidebar.header("2. Lokaler & Logistik")
lokale_buffer = st.sidebar.number_input("Pause ved l√¶rerskift i lokale (min)", value=10, step=5)
default_lokaler = "101, 409, 308, 309, 310, 312, 313, 315, 317, 508, 509, 510, 511, 513, 320, 321, 322, 323, 324, 210, 211, 213, 215, 216, 217, 218, 219, 220, M√∏de 1, M√∏de 2, M√∏de 3, M√∏de 4, M√∏de 5"
lokale_str = st.sidebar.text_area("Lokaler (komma-separeret)", value=default_lokaler)

st.sidebar.markdown("---")
st.sidebar.header("3. Specifikke √∏nsker")
specifikke_tider_raw = st.sidebar.text_area("L√•ste tider (Format: ID=tt.mm)", placeholder="AB=17.30\\n1q 18=17.00")

# --- LOGIK ---

def parse_tider(text_input):
    l√•ste_tider = {}
    if not text_input: return l√•ste_tider
    for line in text_input.split('\\n'):
        if '=' in line:
            parts = line.split('=')
            key = parts[0].strip()
            time_val = parts[1].strip().replace('.', ':')
            l√•ste_tider[key] = time_val
    return l√•ste_tider

def beregn_plan(df, start_str, lokaler_raw, spec_tider_dict, varighed_min, buffer_min):
    try:
        start_dt = datetime.strptime(start_str.replace('.', ':'), "%H:%M")
        df = df.dropna(subset=['Elevnavn', 'Elevid', '√ònsker'])
        df['Elevid'] = df['Elevid'].astype(str).str.strip()
        df['Klasse'] = df['Elevid'].str[:2]
        
        samtaler = []
        l√¶rer_counts = {}
        
        for idx, row in df.iterrows():
            r√•_√∏nsker = [x.strip() for x in str(row['√ònsker']).split(',') if x.strip()]
            for item in r√•_√∏nsker:
                l√¶r = item.split()[0]
                samtaler.append({
                    'Elevnavn': row['Elevnavn'], 'Elevid': row['Elevid'],
                    'L√¶rer': l√¶r, 'Klasse': row['Klasse']
                })
                l√¶rer_counts[l√¶r] = l√¶rer_counts.get(l√¶r, 0) + 1
        
        df_samtaler = pd.DataFrame(samtaler)
        if df_samtaler.empty: return "Ingen gyldige √∏nsker fundet.", {}

        # Prioritering: L√¶rere med under 5 samtaler f√∏rst for tidlig start
        l√¶rere_sm√• = [l for l, c in l√¶rer_counts.items() if c < 5]
        
        l√¶rer_fri = {l: start_dt for l in df_samtaler['L√¶rer'].unique()}
        elev_fri = {e: start_dt for e in df_samtaler['Elevid'].unique()}
        
        # Obligatoriske starttider (fastl√•ses i kalenderen)
        for key, t_str in spec_tider_dict.items():
            t_dt = datetime.strptime(t_str, "%H:%M")
            if key in l√¶rer_fri: l√¶rer_fri[key] = t_dt
            if key in elev_fri: elev_fri[key] = t_dt

        # Sorter samtaler: Sm√• l√¶rere f√∏rst, derefter elevid for sammenh√¶ng
        df_samtaler['sm√•_l√¶rer'] = df_samtaler['L√¶rer'].apply(lambda x: 1 if x in l√¶rere_sm√• else 2)
        df_samtaler = df_samtaler.sort_values(['sm√•_l√¶rer', 'Elevid'])

        f√¶rdig_plan = []
        for _, r in df_samtaler.iterrows():
            l√¶r, e_id = r['L√¶rer'], r['Elevid']
            
            # Obligatorisk starttid tjek: Hvis en af parterne har en fast tid, bruges den.
            # Ellers bruges den tidligst mulige f√¶lles tid.
            st_tid = max(l√¶rer_fri[l√¶r], elev_fri[e_id])
            sl_tid = st_tid + timedelta(minutes=varighed_min)
            
            f√¶rdig_plan.append({
                'Elevnavn': r['Elevnavn'], 'Elevid': e_id, 'Klasse': r['Klasse'],
                'L√¶rer': l√¶r, 'Start_dt': st_tid, 'Slut_dt': sl_tid
            })
            l√¶rer_fri[l√¶r] = sl_tid
            elev_fri[e_id] = sl_tid

        res_df = pd.DataFrame(f√¶rdig_plan)
        lokaler = [l.strip() for l in lokaler_raw.split(',') if l.strip()]
        l√¶rer_blokke = res_df.groupby('L√¶rer').agg(Min_Start=('Start_dt', 'min'), Max_Slut=('Slut_dt', 'max')).reset_index().sort_values('Min_Start')
        
        lokale_ledig_fra = {lok: start_dt - timedelta(minutes=buffer_min) for lok in lokaler}
        l√¶rer_til_lokale = {}
        lokale_brugere = {lok: [] for lok in lokaler}
        
        for _, row in l√¶rer_blokke.iterrows():
            l√¶r, s_blok = row['L√¶rer'], row['Min_Start']
            valgt = None
            for lok in lokaler:
                if s_blok >= lokale_ledig_fra[lok] + timedelta(minutes=buffer_min):
                    valgt = lok
                    lokale_ledig_fra[lok] = row['Max_Slut']
                    lokale_brugere[lok].append(str(l√¶r))
                    break
            l√¶rer_til_lokale[l√¶r] = valgt if valgt else "‚ö†Ô∏è MANGLER LOKALE"

        res_df['Lokale'] = res_df['L√¶rer'].map(l√¶rer_til_lokale)
        res_df['Start'] = res_df['Start_dt'].dt.strftime("%H:%M")
        return res_df, lokale_brugere

    except Exception as e: return str(e), {}

# --- EXCEL ---

def generate_excel_elev(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        for k in sorted(df['Klasse'].unique()):
            df_k = df[df['Klasse'] == k]
            p = df_k.pivot_table(index='Elevnavn', columns=['L√¶rer', 'Lokale'], values='Start', aggfunc='first').fillna("")
            if isinstance(p.columns, pd.MultiIndex): p.columns = [f"{l} ({loc})" for l, loc in p.columns]
            p.to_excel(writer, sheet_name=f'Klasse {k}')
    return output.getvalue()

def generate_excel_laerer(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        adm = df.pivot_table(index='Start', columns=['Lokale', 'L√¶rer'], values='Elevid', aggfunc='first').fillna("")
        if isinstance(adm.columns, pd.MultiIndex): adm.columns = [f"{lok}: {l}" for lok, l in adm.columns]
        adm.to_excel(writer, sheet_name="ADMIN_SAMLET_PLAN")
        for l√¶r in sorted(df['L√¶rer'].unique()):
            df_l = df[df['L√¶rer'] == l√¶r]
            sh = str(l√¶r)[:31].translate({ord(c): None for c in '[]*?/:\\\\'})
            df_l[['Start', 'Elevnavn', 'Elevid', 'Klasse']].sort_values('Start').to_excel(writer, sheet_name=sh, index=False, startrow=2)
            ws = writer.sheets[sh]
            ws.write(0, 0, f"L√¶rer: {l√¶r}"); ws.write(1, 0, f"Lokale: {df_l['Lokale'].iloc[0]}")
    return output.getvalue()

# --- UI ---
st.info("Krav: Kolonner 'Elevnavn', 'Elevid', '√ònsker'.")
uploaded_file = st.file_uploader("Upload Excel", type=["xlsx"])

if uploaded_file:
    df_in = pd.read_excel(uploaded_file)
    if all(col in df_in.columns for col in ['Elevnavn', 'Elevid', '√ònsker']):
        res, lok_brug = beregn_plan(df_in, start_tid_input, lokale_str, parse_tider(specifikke_tider_raw), varighed, lokale_buffer)
        if isinstance(res, str): st.error(f"Fejl: {res}")
        else:
            delte = [f"{lok} ({', '.join([str(b) for b in br if pd.notna(b)])})" for lok, br in lok_brug.items() if len([b for b in br if pd.notna(b)]) > 1]
            sidste = res.sort_values('Start_dt').iloc[-1]
            if any(res['Lokale'] == "‚ö†Ô∏è MANGLER LOKALE"): st.error("‚ö†Ô∏è MANGEL P√Ö LOKALER!")
            st.success(f"F√¶rdig! Sidste samtale slutter kl. {sidste['Slut_dt'].strftime('%H:%M')} ({sidste['L√¶rer']}).")
            if delte: st.warning(f"‚ÑπÔ∏è Delte lokaler: {'; '.join(delte)}")
            c1, c2 = st.columns(2)
            c1.download_button("üì• Hent Elevoversigt", data=generate_excel_elev(res), file_name="Elevoversigt.xlsx")
            c2.download_button("üì• Hent L√¶reroversigt", data=generate_excel_laerer(res), file_name="Laereroversigt.xlsx")
`
        },
      });
    </script>
  </body>
</html>
