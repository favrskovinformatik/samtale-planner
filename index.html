<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger - Stabil & Kompakt</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl", "xlsxwriter"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide")
st.title("üóìÔ∏è Samtaleplanl√¶gger - Stabil Udgave")

# --- SIDEBAR ---
st.sidebar.header("1. Indstillinger")
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00")
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5)
lokale_buffer = st.sidebar.number_input("Pause ved l√¶rerskift (min)", value=10, step=5)
default_lokaler = "101, 409, 308, 309, 310, 312, 313, 315, 317, 508, 509, 510, 511, 513, 320, 321, 322, 323, 324, 210, 211, 213, 215, 216, 217, 218, 219, 220, M√∏de 1, M√∏de 2, M√∏de 3, M√∏de 4, M√∏de 5"
lokale_str = st.sidebar.text_area("Lokaler (komma-separeret)", value=default_lokaler)
spec_tider_raw = st.sidebar.text_area("L√•ste tider (ID=tt.mm)")

def beregn_plan_stabil(df, start_str, lokaler_raw, spec_tider_dict, varighed_min, buffer_min):
    try:
        start_dt = datetime.strptime(start_str.replace('.', ':'), "%H:%M")
        df = df.dropna(subset=['Elevnavn', 'Elevid', '√ònsker'])
        df['Elevid'] = df['Elevid'].astype(str).str.strip()
        
        samtaler_liste = []
        for _, row in df.iterrows():
            √∏nsker = [x.strip() for x in str(row['√ònsker']).split(',') if x.strip()]
            for item in √∏nsker:
                l√¶r = item.split()[0]
                samtaler_liste.append({'Elevid': row['Elevid'], 'Elevnavn': row['Elevnavn'], 'L√¶rer': l√¶r, 'Klasse': row['Elevid'][:2]})
        
        df_samtaler = pd.DataFrame(samtaler_liste)
        alle_l√¶rere = df_samtaler['L√¶rer'].unique()
        alle_elever = df_samtaler['Elevid'].unique()

        l√¶rer_fri = {l: start_dt for l in alle_l√¶rere}
        elev_fri = {e: start_dt for e in alle_elever}
        
        for k, v in spec_tider_dict.items():
            t = datetime.strptime(v, "%H:%M")
            if k in l√¶rer_fri: l√¶rer_fri[k] = t
            if k in elev_fri: elev_fri[k] = t

        # Vi planl√¶gger l√¶rere i r√¶kkef√∏lge, men finder de bedste elever til deres "huller"
        f√¶rdig_plan = []
        resterende = df_samtaler.copy()
        
        # Sorter l√¶rere: Dem med l√•ste tider f√∏rst, derefter dem med flest samtaler
        l√¶rer_prioritet = sorted(alle_l√¶rere, key=lambda x: (0 if x in spec_tider_dict else 1, -len(df_samtaler[df_samtaler['L√¶rer']==x])))

        for l√¶r in l√¶rer_prioritet:
            while True:
                mine_elever = resterende[resterende['L√¶rer'] == l√¶r]
                if mine_elever.empty: break
                
                # VIGTIGT: Find den elev der er ledig TIDLIGST (minimerer ventetid)
                bedste_elev_idx = -1
                tidligste_start = datetime.max
                
                for idx, row in mine_elever.iterrows():
                    e = row['Elevid']
                    mulig_start = max(l√¶rer_fri[l√¶r], elev_fri[e])
                    if mulig_start < tidligste_start:
                        tidligste_start = mulig_start
                        bedste_elev_idx = idx
                
                # Book samtalen
                valgt = mine_elever.loc[bedste_elev_idx]
                st_tid = tidligste_start
                sl_tid = st_tid + timedelta(minutes=varighed_min)
                
                f√¶rdig_plan.append({**valgt.to_dict(), 'Start_dt': st_tid, 'Slut_dt': sl_tid})
                l√¶rer_fri[l√¶r] = sl_tid
                elev_fri[valgt['Elevid']] = sl_tid
                resterende = resterende.drop(bedste_elev_idx)

        res_df = pd.DataFrame(f√¶rdig_plan)
        
        # LOKALER - Den stabile algoritme
        lokaler = [l.strip() for l in lokaler_raw.split(',') if l.strip()]
        l√¶rer_blokke = res_df.groupby('L√¶rer').agg(Min_Start=('Start_dt', 'min'), Max_Slut=('Slut_dt', 'max')).reset_index().sort_values('Min_Start')
        lokale_ledig_fra = {lok: start_dt - timedelta(minutes=buffer_min) for lok in lokaler}
        l√¶rer_til_lokale = {}
        
        for _, row in l√¶rer_blokke.iterrows():
            l√¶r, s_blok = row['L√¶rer'], row['Min_Start']
            valgt_lok = None
            for lok in lokaler:
                if s_blok >= lokale_ledig_fra[lok] + timedelta(minutes=buffer_min):
                    valgt_lok = lok
                    lokale_ledig_fra[lok] = row['Max_Slut']
                    break
            l√¶rer_til_lokale[l√¶r] = valgt_lok if valgt_lok else "‚ö†Ô∏è MANGLER LOKALE"

        res_df['Lokale'] = res_df['L√¶rer'].map(l√¶rer_til_lokale)
        res_df['Start'] = res_df['Start_dt'].dt.strftime("%H:%M")
        
        advarsler = []
        for e in alle_elever:
            e_p = res_df[res_df['Elevid'] == e].sort_values('Start_dt')
            for i in range(len(e_p)-1):
                gap = (e_p.iloc[i+1]['Start_dt'] - e_p.iloc[i]['Slut_dt']).total_seconds() / 60
                if gap > 20: advarsler.append(f"{e_p.iloc[0]['Elevnavn']} ({e}): {int(gap)} min")
                    
        return res_df, advarsler
    except Exception as e: return str(e), []

# --- UI ---
uploaded_file = st.file_uploader("Upload Excel", type=["xlsx"])
if uploaded_file:
    df_in = pd.read_excel(uploaded_file)
    spec_dict = {}
    if spec_tider_raw:
        for line in spec_tider_raw.split('\\n'):
            if '=' in line:
                k, v = line.split('=')
                spec_dict[k.strip()] = v.strip().replace('.', ':')
                
    res, adv = beregn_plan_stabil(df_in, start_tid_input, lokale_str, spec_dict, varighed, lokale_buffer)
    
    if isinstance(res, str): st.error(res)
    else:
        sidste = res.sort_values('Start_dt').iloc[-1]
        st.success(f"F√¶rdig! Sidste samtale kl. {sidste['Slut_dt'].strftime('%H:%M')}")
        if any(res['Lokale'] == "‚ö†Ô∏è MANGLER LOKALE"): st.error("‚ö†Ô∏è LOKALEMANGEL!")
        if adv:
            with st.expander("‚ö†Ô∏è Ventetider > 20 min"):
                for a in adv: st.write(f"- {a}")
        
        output = io.BytesIO()
        with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
            res.sort_values(['Klasse', 'Elevnavn', 'Start_dt']).to_excel(writer, index=False, sheet_name="Plan")
        st.download_button("üì• Hent Plan", data=output.getvalue(), file_name="Samtaleplan.xlsx")
`
        },
      });
    </script>
  </body>
</html>
