<!DOCTYPE html> 
<html> 
  <head> 
    <meta charset="UTF-8" /> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" /> 
    <title>Samtaleplanl√¶gger - Brute Force Optimering</title> 
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" /> 
  </head> 
  <body> 
    <div id="root"></div> 
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script> 
    <script> 
      stlite.mount({ 
        requirements: ["pandas", "openpyxl", "xlsxwriter"], 
        files: { 
          "streamlit_app.py": ` 
import streamlit as st 
import pandas as pd 
from datetime import datetime, timedelta 
import io 
import random

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide", page_icon="üóìÔ∏è") 

# --- UI STYLING --- 
st.markdown(""" 
<style> 
    [data-testid="stSidebar"] { min-width: 450px !important; } 
    .stTextInput label, .stTextArea label, .stNumberInput label { font-weight: bold; } 
</style> 
""", unsafe_allow_html=True) 

st.title("üóìÔ∏è Samtaleplanl√¶gger") 

# --- INSTRUKTION OG EKSEMPEL --- 
st.info("### 1. Forbered din Excel-fil") 
st.markdown("S√∏rg for at dit regneark har pr√¶cis disse tre kolonneoverskrifter: **Elevnavn**, **Elevid**, **√ònsker**.") 

example_data = { 
    "Elevnavn": ["Jonas Petersen"], 
    "Elevid": ["1x 07"], 
    "√ònsker": ["AG samfundsfag, SR, FH biologi"] 
} 
st.table(pd.DataFrame(example_data)) 

# --- SIDEBAR --- 
st.sidebar.header("1. Indstillinger") 
start_tid_input = st.sidebar.text_input("Starttidspunkt (tt.mm)", value="17.00") 
varighed = st.sidebar.number_input("Varighed (min)", value=10, step=5) 

st.sidebar.markdown("---") 
st.sidebar.header("2. Lokaler & Logistik") 
lokale_buffer = st.sidebar.number_input("Pause ved l√¶rerskift i lokale (min)", value=10, step=5) 
default_lokaler = "101, 409, 308, 309, 310, 312, 313, 315, 317, 508, 509, 510, 511, 513, 320, 321, 322, 323, 324, 210, 211, 213, 215, 216, 217, 218, 219, 220, M√∏de 1, M√∏de 2, M√∏de 3, M√∏de 4, M√∏de 5" 
lokale_str = st.sidebar.text_area("Lokaler (komma-separeret)", value=default_lokaler) 

st.sidebar.markdown("---") 
st.sidebar.header("3. Specifikke √∏nsker") 
specifikke_tider_raw = st.sidebar.text_area("Vejledninger (Format: ID=tt.mm)", placeholder="AB=17.30\\n1q 18=17.00") 

# --- LOGIK --- 

def parse_tider(text_input): 
    l√•ste_tider = {} 
    if not text_input: return l√•ste_tider 
    for line in text_input.split('\\n'): 
        if '=' in line: 
            parts = line.split('=') 
            key = parts[0].strip() 
            time_val = parts[1].strip().replace('.', ':') 
            l√•ste_tider[key] = time_val 
    return l√•ste_tider 

def single_heuristic_run(df_opgaver, global_start, spec_tider_dict, varighed_min):
    alle_l√¶rere = list(df_opgaver['L√¶rer'].unique())
    alle_elever = list(df_opgaver['Elevid'].unique())
    
    # Randomiser r√¶kkef√∏lgen af l√¶rere for at skabe variation i hver test
    random.shuffle(alle_l√¶rere)
    
    l√¶rer_fri = {l: global_start for l in alle_l√¶rere} 
    elev_fri = {e: global_start for e in alle_elever} 
    
    for k, v in spec_tider_dict.items(): 
        t = datetime.strptime(v, "%H:%M") 
        if k in l√¶rer_fri: l√¶rer_fri[k] = t 
        if k in elev_fri: elev_fri[k] = t 

    f√¶rdig_plan = [] 
    resterende = df_opgaver.copy() 
    
    # Planl√¶g alle opgaver
    for l√¶r in alle_l√¶rere:
        while True:
            mine = resterende[resterende['L√¶rer'] == l√¶r]
            if mine.empty: break
            
            # Find elev med tidligste mulige start (som i udgave 2)
            bedste_idx = -1
            min_st = datetime.max
            
            # Vi tager eleverne i tilf√¶ldig r√¶kkef√∏lge for at finde forskellige l√∏sninger
            mine_indices = list(mine.index)
            random.shuffle(mine_indices)
            
            for idx in mine_indices:
                e = mine.at[idx, 'Elevid']
                mulig_st = max(l√¶rer_fri[l√¶r], elev_fri[e])
                if mulig_st < min_st:
                    min_st = mulig_st
                    bedste_idx = idx
            
            valgt = mine.loc[bedste_idx]
            res_item = {**valgt.to_dict(), 'Start_dt': min_st, 'Slut_dt': min_st + timedelta(minutes=varighed_min)} 
            f√¶rdig_plan.append(res_item) 
            l√¶rer_fri[l√¶r] = res_item['Slut_dt'] 
            elev_fri[valgt['Elevid']] = res_item['Slut_dt'] 
            resterende = resterende.drop(bedste_idx)

    res_df = pd.DataFrame(f√¶rdig_plan)
    
    # --- EVALUERING AF DENNE PLAN ---
    # 1. T√¶l elev-gaps over 20 min
    elev_bad_gaps = 0
    for e in alle_elever:
        e_p = res_df[res_df['Elevid'] == e].sort_values('Start_dt')
        for i in range(len(e_p)-1):
            gap = (e_p.iloc[i+1]['Start_dt'] - e_p.iloc[i]['Slut_dt']).total_seconds() / 60
            if gap > 20:
                elev_bad_gaps += 1
                
    # 2. Beregn l√¶rernes gns ventetid
    pauser = []
    for l√¶r in alle_l√¶rere:
        l_p = res_df[res_df['L√¶rer'] == l√¶r].sort_values('Start_dt')
        for i in range(len(l_p)-1):
            pauser.append((l_p.iloc[i+1]['Start_dt'] - l_p.iloc[i]['Slut_dt']).total_seconds() / 60)
    avg_l√¶r_pause = sum(pauser) / len(pauser) if pauser else 0
    
    return {
        'df': res_df,
        'bad_gaps': elev_bad_gaps,
        'avg_pause': avg_l√¶r_pause
    }

def koer_optimeret_proces(df, start_str, lokaler_raw, spec_tider_dict, varighed_min, buffer_min):
    global_start = datetime.strptime(start_str.replace('.', ':'), "%H:%M") 
    df = df.dropna(subset=['Elevnavn', 'Elevid', '√ònsker']) 
    df['Elevid'] = df['Elevid'].astype(str).str.strip() 
    df['Klasse'] = df['Elevid'].str[:2] 
    
    opgaver_liste = [] 
    for _, row in df.iterrows(): 
        √∏nsker = [x.strip() for x in str(row['√ònsker']).split(',') if x.strip()] 
        for item in √∏nsker: 
            l√¶r = item.split()[0] 
            opgaver_liste.append({'Elevid': row['Elevid'], 'Elevnavn': row['Elevnavn'], 'L√¶rer': l√¶r, 'Klasse': row['Klasse']}) 
    
    df_opgaver = pd.DataFrame(opgaver_liste)
    alle_tests = []
    
    # Vi k√∏rer 100 tests for at finde den bedste plan
    for _ in range(100):
        alle_tests.append(single_heuristic_run(df_opgaver, global_start, spec_tider_dict, varighed_min))
    
    # Sortering: 1. F√¶rrest elev-gaps (vi vil have 0), 2. Mindst l√¶rer-pause
    alle_tests.sort(key=lambda x: (x['bad_gaps'], x['avg_pause']))
    
    bedste_test = alle_tests[0]
    res_df = bedste_test['df']
    
    # Tildel lokaler til det valgte resultat
    lokaler = [l.strip() for l in lokaler_raw.split(',') if l.strip()] 
    lokale_ledig_fra = {lok: global_start - timedelta(minutes=buffer_min) for lok in lokaler} 
    l√¶rer_til_lokale = {} 
    l√¶rer_blokke = res_df.groupby('L√¶rer').agg(Min_S=('Start_dt', 'min'), Max_S=('Slut_dt', 'max')).reset_index().sort_values('Min_S') 
    
    for _, row in l√¶rer_blokke.iterrows(): 
        valgt_lok = next((lok for lok in lokaler if row['Min_S'] >= lokale_ledig_fra[lok] + timedelta(minutes=buffer_min)), None) 
        if valgt_lok: 
            l√¶rer_til_lokale[row['L√¶rer']] = valgt_lok 
            lokale_ledig_fra[valgt_lok] = row['Max_S'] 
        else: l√¶rer_til_lokale[row['L√¶rer']] = "‚ö†Ô∏è MANGLER LOKALE" 

    res_df['Lokale'] = res_df['L√¶rer'].map(l√¶rer_til_lokale) 
    res_df['Start'] = res_df['Start_dt'].dt.strftime("%H:%M") 
    
    # Lav advarselsliste til UI
    advarsler = []
    alle_elever = res_df['Elevid'].unique()
    for e in alle_elever:
        e_p = res_df[res_df['Elevid'] == e].sort_values('Start_dt')
        for i in range(len(e_p)-1):
            gap = (e_p.iloc[i+1]['Start_dt'] - e_p.iloc[i]['Slut_dt']).total_seconds() / 60
            if gap > 20:
                advarsler.append(f"{e_p.iloc[0]['Elevnavn']} ({e}): {int(gap)} min")

    return res_df, advarsler, bedste_test['avg_pause'], alle_tests

# --- APP FLOW --- 
uploaded_file = st.file_uploader("Upload Excel med de korrekte kolonner", type=["xlsx"]) 
if uploaded_file: 
    df_in = pd.read_excel(uploaded_file) 
    if all(col in df_in.columns for col in ['Elevnavn', 'Elevid', '√ònsker']): 
        with st.spinner('K√∏rer 100 forskellige planl√¶gnings-tests for at finde den bedste l√∏sning...'):
            res, adv, avg_p, alle_tests = koer_optimeret_proces(df_in, start_tid_input, lokale_str, parse_tider(specifikke_tider_raw), varighed, lokale_buffer) 
        
        st.success(f"F√¶rdig! Sidste samtale kl. {res.sort_values('Slut_dt').iloc[-1]['Slut_dt'].strftime('%H:%M')}") 
        st.write(f"üìä **Gennemsnitlig ventetid for l√¶rere:** {avg_p:.1f} min.") 
        
        # --- TEST OVERSIGT ---
        with st.expander("üîç Se resultater fra alle 100 tests"):
            test_data = []
            for i, t in enumerate(alle_tests):
                test_data.append({"Test nr": i+1, "Elev-gaps > 20m": t['bad_gaps'], "L√¶rer-pause (gns)": round(t['avg_pause'], 1)})
            st.table(pd.DataFrame(test_data).head(10)) # Vis de 10 bedste
            st.caption("Tabellen viser de 10 bedste tests sorteret efter f√¶rrest elev-gaps og derefter mindst l√¶rer-pause.")

        if any(res['Lokale'] == "‚ö†Ô∏è MANGLER LOKALE"): st.error("‚ö†Ô∏è LOKALEMANGEL!") 
        if adv: 
            with st.expander(f"‚ö†Ô∏è Ventetider over 20 minutter ({len(adv)} stk)"): 
                for a in adv: st.write(f"- {a}") 
        else:
            st.balloons()
            st.success("‚úÖ Succes! Ingen elever har over 20 minutters ventetid i denne plan.")

        st.markdown("### Download resultater") 
        c1, c2 = st.columns(2) 
        c1.download_button("üì• Hent Elevoversigt", data=generate_excel_elev(res), file_name="Elevoversigt.xlsx") 
        c2.download_button("üì• Hent L√¶reroversigt", data=generate_excel_laerer(res), file_name="Laereroversigt.xlsx") 
` 
        }, 
      }); 
    </script> 
  </body> 
</html>
