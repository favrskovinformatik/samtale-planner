<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Samtaleplanl√¶gger</title>
    <script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.css" />
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.39.0/build/stlite.js"></script>
    <script>
      stlite.mount({
        requirements: ["pandas", "openpyxl"],
        files: {
          "streamlit_app.py": `
import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
import io

st.set_page_config(page_title="Samtaleplanl√¶gger", layout="wide")

# --- CSS til styling ---
st.markdown("""
<style>
    [data-testid="stSidebar"] { min-width: 450px !important; }
    .stDataFrame { width: 100%; }
</style>
""", unsafe_allow_html=True)

st.title("üóìÔ∏è Samtaleplanl√¶gger")
st.info("Denne app planl√¶gger samtaler baseret p√• elev√∏nsker og lokalebegr√¶nsninger.")

# --- SIDEBAR: Indstillinger ---
st.sidebar.header("‚öôÔ∏è Generelle Indstillinger")
start_tid_gen = st.sidebar.text_input("Generelt starttidspunkt (tt:mm)", value="08:00")
lokale_liste = st.sidebar.text_area("Lokaler (komma-separeret)", value="Lokale 1, Lokale 2, Lokale 3, Lokale 4")
samtale_varighed = 10

st.sidebar.header("üë§ Specifikke starttider (Valgfrit)")
specifikke_tider_input = st.sidebar.text_area("Format: Navn=tt:mm (f.eks. 'L√¶rer AB=09:00' eller 'Elev 123=08:30')", help="√ân pr. linje")

def parse_specifikke_tider(text):
    res = {}
    for line in text.split('\\n'):
        if '=' in line:
            parts = line.split('=')
            res[parts[0].strip()] = parts[1].strip()
    return res

# --- LOGIK: Planl√¶gningsmotor ---
def planl√¶g_samtaler(df, start_gen, lokaler_str, spec_tider):
    try:
        start_dt_gen = datetime.strptime(start_gen.replace(".", ":"), "%H:%M")
        lokaler = [l.strip() for l in lokaler_str.split(",") if l.strip()]
        
        # 1. Forbered data
        # '√ònsker' kolonnen splittes op (antager komma-separeret l√¶rernavne/initialer)
        df['L√¶rer_Liste'] = df['√ònsker'].astype(str).apply(lambda x: [i.strip() for i in x.split(',')])
        
        alle_√∏nsker = []
        for _, row in df.iterrows():
            for l√¶rer in row['L√¶rer_Liste']:
                alle_√∏nsker.append({
                    'Elevnavn': row['Elevnavn'],
                    'Elevid': str(row['Elevid']),
                    'L√¶rer': l√¶rer
                })
        
        √∏nsker_df = pd.DataFrame(alle_√∏nsker)
        l√¶rere = √∏nsker_df['L√¶rer'].unique()
        
        # 2. Tildel lokaler til l√¶rere (En l√¶rer har √©t lokale)
        l√¶rer_lokale = {}
        lokale_ledig_fra = {l: start_dt_gen for l in lokaler}
        
        # Sorter l√¶rere efter belastning for at fylde lokaler effektivt
        l√¶rer_belastning = √∏nsker_df['L√¶rer'].value_counts()
        for i, l√¶rer in enumerate(l√¶rer_belastning.index):
            assigned_lokale = lokaler[i % len(lokaler)]
            l√¶rer_lokale[l√¶rer] = assigned_lokale

        # 3. Planl√¶gning
        bookinger = [] # Liste af dicts: {Elev, L√¶rer, Lokale, Start, Slut}
        l√¶rer_optaget_indtil = {l√¶rer: start_dt_gen for l√¶rer in l√¶rere}
        elev_optaget_indtil = {str(eid): start_dt_gen for eid in df['Elevid']}
        
        # H√•ndter specifikke starttider
        for navn, tid_str in spec_tider.items():
            t_dt = datetime.strptime(tid_str.replace(".", ":"), "%H:%M")
            if navn in l√¶rer_optaget_indtil:
                l√¶rer_optaget_indtil[navn] = t_dt
            if navn in elev_optaget_indtil:
                elev_optaget_indtil[navn] = t_dt

        # Sorter √∏nsker for at fors√∏ge at samle elevens samtaler
        # Vi tager √©n elev ad gangen
        for eid in df['Elevid'].astype(str):
            elev_samtaler = √∏nsker_df[√∏nsker_df['Elevid'] == eid]
            
            for _, r in elev_samtaler.iterrows():
                l = r['L√¶rer']
                lok = l√¶rer_lokale[l]
                
                # Find det tidspunkt hvor b√•de l√¶rer, elev OG lokale er ledige
                start_tid = max(l√¶rer_optaget_indtil[l], elev_optaget_indtil[eid])
                
                slut_tid = start_tid + timedelta(minutes=samtale_varighed)
                
                bookinger.append({
                    'Elevnavn': r['Elevnavn'],
                    'Elevid': eid,
                    'L√¶rer': l,
                    'Lokale': lok,
                    'Start': start_tid.strftime("%H:%M"),
                    'Slut': slut_tid.strftime("%H:%M"),
                    'Klasse': str(eid)[:2] # Antager de f√∏rste to cifre er klassen
                })
                
                l√¶rer_optaget_indtil[l] = slut_tid
                elev_optaget_indtil[eid] = slut_tid

        return pd.DataFrame(bookinger)
    except Exception as e:
        st.error(f"Fejl i planl√¶gning: {e}")
        return None

# --- UI: Fil Upload ---
uploaded_file = st.file_uploader("Upload Excel-fil (Elevnavn, Elevid, √ònsker)", type=["xlsx"])

if uploaded_file:
    df_input = pd.read_excel(uploaded_file)
    spec_tider = parse_specifikke_tider(specifikke_tider_input)
    
    res_df = planl√¶g_samtaler(df_input, start_tid_gen, lokale_liste, spec_tider)
    
    if res_df is not None:
        st.success("‚úÖ Planl√¶gning genereret!")
        
        # --- OUTPUT 1: L√¶reroversigt ---
        st.subheader("üë®‚Äçüè´ L√¶reroversigt")
        # Pivot: R√¶kker = Tid, Kolonner = L√¶rer (Lokale)
        res_df['L√¶rer_Lokale'] = res_df['L√¶rer'] + " (" + res_df['Lokale'] + ")"
        laerer_pivot = res_df.pivot(index='Start', columns='L√¶rer_Lokale', values='Elevid').fillna("-")
        st.dataframe(laerer_pivot, use_container_width=True)
        
        # --- OUTPUT 2: Elevoversigt (Klasseopdelt) ---
        st.subheader("üéì Elevoversigt (pr. klasse)")
        klasser = sorted(res_df['Klasse'].unique())
        
        for kl in klasser:
            with st.expander(f"Klasse {kl}"):
                kl_df = res_df[res_df['Klasse'] == kl]
                # Pivot: R√¶kker = Elevnavn, Kolonner = L√¶rer (Lokale), V√¶rdier = Tid
                elev_pivot = kl_df.pivot(index='Elevnavn', columns='L√¶rer_Lokale', values='Start').fillna("-")
                st.dataframe(elev_pivot, use_container_width=True)

        # --- DOWNLOAD ---
        def to_excel(df_res):
            output = io.BytesIO()
            with pd.ExcelWriter(output, engine='openpyxl') as writer:
                # Samlet ark
                df_res.to_excel(writer, index=False, sheet_name='Samlet_Plan')
                # L√¶rer ark
                laerer_pivot.to_excel(writer, sheet_name='Laerer_Oversigt')
            return output.getvalue()

        st.download_button("üì• Hent Plan (Excel)", to_excel(res_df), "samtaleplan.xlsx")
`
        },
      });
    </script>
  </body>
</html>
